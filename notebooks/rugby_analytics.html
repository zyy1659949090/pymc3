
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>A Hierarchical model for Rugby prediction &#8212; PyMC3 3.2 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '3.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Bayesian Survival Analysis" href="survival_analysis.html" />
    <link rel="prev" title="Probabilistic Matrix Factorization for Making Personalized Recommendations" href="probabilistic_matrix_factorization.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #D84315;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 8ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }
</style>
<div class="section" id="A-Hierarchical-model-for-Rugby-prediction">
<h1>A Hierarchical model for Rugby prediction<a class="headerlink" href="#A-Hierarchical-model-for-Rugby-prediction" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li>&#64;Author: Peadar Coyle</li>
<li>&#64;email: <a class="reference external" href="mailto:peadarcoyle&#37;&#52;&#48;googlemail&#46;com">peadarcoyle<span>&#64;</span>googlemail<span>&#46;</span>com</a></li>
<li>&#64;date: 31/12/15</li>
</ul>
<p>I came across the following blog post on
<a class="reference external" href="http://danielweitzenfeld.github.io/passtheroc/blog/2014/10/28/bayes-premier-league/">http://danielweitzenfeld.github.io/passtheroc/blog/2014/10/28/bayes-premier-league/</a></p>
<ul class="simple">
<li>Based on the work of <a class="reference external" href="www.statistica.it/gianluca/Research/BaioBlangiardo.pdf">Baio and
Blangiardo</a></li>
</ul>
<p>In this example, we’re going to reproduce the first model described in
the paper using PyMC3.</p>
<p>Since I am a rugby fan I decide to apply the results of the paper
Bayesian Football to the Six Nations. Rugby is a physical sport popular
worldwide.</p>
<ul class="simple">
<li>Six Nations consists of Italy, Ireland, Scotland, England, France and
Wales</li>
<li>Game consists of scoring tries (similar to touch downs) or kicking
the goal.</li>
<li>Average player is something like 100kg and 1.82m tall.</li>
<li>Paul O’Connell the Irish captain is Height: 6’ 6” (1.98 m) Weight:
243 lbs (110 kg)</li>
</ul>
<p>We will use a data set only consisting of the Six Nations 2014 data, and
use this to build a generative and explainable model about the Six
Nations 2015.</p>
<div class="section" id="Motivation">
<h2>Motivation<a class="headerlink" href="#Motivation" title="Permalink to this headline">¶</a></h2>
<p>Your estimate of the strength of a team depends on your estimates of the
other strengths</p>
<p>Ireland are a stronger team than Italy for example - but by how much?</p>
<p>Source for Results 2014 are Wikipedia.</p>
<ul class="simple">
<li>We want to infer a latent parameter - that is the ‘strength’ of a
team based only on their <strong>scoring intensity</strong>, and all we have are
their scores and results, we can’t accurately measure the ‘strength’
of a team.</li>
<li>Probabilistic Programming is a brilliant paradigm for modeling these
<strong>latent</strong> parameters</li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="o">!</span>date

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">StringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">pymc3</span> <span class="kn">as</span> <span class="nn">pm</span><span class="o">,</span> <span class="nn">theano.tensor</span> <span class="kn">as</span> <span class="nn">tt</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Fri Jun 23 15:21:32 EDT 2017
</pre></div></div>
</div>
<p>This is a Rugby prediction exercise. So we’ll input some data</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">data_csv</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;home_team,away_team,home_score,away_score</span>
<span class="s2">Wales,Italy,23,15</span>
<span class="s2">France,England,26,24</span>
<span class="s2">Ireland,Scotland,28,6</span>
<span class="s2">Ireland,Wales,26,3</span>
<span class="s2">Scotland,England,0,20</span>
<span class="s2">France,Italy,30,10</span>
<span class="s2">Wales,France,27,6</span>
<span class="s2">Italy,Scotland,20,21</span>
<span class="s2">England,Ireland,13,10</span>
<span class="s2">Ireland,Italy,46,7</span>
<span class="s2">Scotland,France,17,19</span>
<span class="s2">England,Wales,29,18</span>
<span class="s2">Italy,England,11,52</span>
<span class="s2">Wales,Scotland,51,3</span>
<span class="s2">France,Ireland,20,22&quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="What-do-we-want-to-infer?">
<h2>What do we want to infer?<a class="headerlink" href="#What-do-we-want-to-infer?" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>We want to infer the latent paremeters (every team’s strength) that
are generating the data we observe (the scorelines).</li>
<li>Moreover, we know that the scorelines are a noisy measurement of team
strength, so ideally, we want a model that makes it easy to quantify
our uncertainty about the underlying strengths.</li>
<li>Often we don’t know what the Bayesian Model is explicitly, so we have
to ‘estimate’ the Bayesian Model’</li>
<li>If we can’t solve something, approximate it.</li>
<li>Markov-Chain Monte Carlo (MCMC) instead draws samples from the
posterior.</li>
<li>Fortunately, this algorithm can be applied to almost any model.</li>
</ul>
</div>
<div class="section" id="What-do-we-want?">
<h2>What do we want?<a class="headerlink" href="#What-do-we-want?" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>We want to quantify our uncertainty</li>
<li>We want to also use this to generate a model</li>
<li>We want the answers as distributions not point estimates</li>
</ul>
</div>
<div class="section" id="What-assumptions-do-we-know-for-our-'generative-story'?">
<h2>What assumptions do we know for our ‘generative story’?<a class="headerlink" href="#What-assumptions-do-we-know-for-our-'generative-story'?" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>We know that the Six Nations in Rugby only has 6 teams - they each
play each other once</li>
<li>We have data from last year!</li>
<li>We also know that in sports scoring is modelled as a Poisson
distribution</li>
<li>We consider home advantage to be a strong effect in sports</li>
</ul>
</div>
<div class="section" id="The-model.">
<h2>The model.<a class="headerlink" href="#The-model." title="Permalink to this headline">¶</a></h2>
<p>The league is made up by a total of T= 6 teams, playing each other once
in a season. We indicate the number of points scored by the home and the
away team in the g-th game of the season (15 games) as <span class="math">\(y_{g1}\)</span>
and <span class="math">\(y_{g2}\)</span> respectively.</p>
</p><p>The vector of observed counts <span class="math">\(\mathbb{y} = (y_{g1}, y_{g2})\)</span> is
modelled as independent Poisson:
<span class="math">\(y_{gi}| \theta_{gj} \tilde\;\;  Poisson(\theta_{gj})\)</span> where the
theta parameters represent the scoring intensity in the g-th game for
the team playing at home (j=1) and away (j=2), respectively.</p>
</p><p>We model these parameters according to a formulation that has been used
widely in the statistical literature, assuming a log-linear random
effect model:</p>
<div class="math">
\[log \theta_{g1} = home + att_{h(g)} + def_{a(g)}\]</div>
<div class="math">
\[log \theta_{g2} = att_{a(g)} + def_{h(g)}\]</div>
<ul class="simple">
<li>The parameter home represents the advantage for the team hosting the
game and we assume that this effect is constant for all the teams and
throughout the season</li>
<li>The scoring intensity is determined jointly by the attack and defense
ability of the two teams involved, represented by the parameters att
and def, respectively</li>
<li>Conversely, for each t = 1, …, T, the team-specific effects are
modelled as exchangeable from a common distribution:</li>
<li><span class="math">\(att_{t} \; \tilde\;\; Normal(\mu_{att},\tau_{att})\)</span> and
<span class="math">\(def_{t} \; \tilde\;\;Normal(\mu_{def},\tau_{def})\)</span></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_csv</span><span class="p">)</span>

<span class="n">teams</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">home_team</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="n">teams</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">teams</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;team&#39;</span><span class="p">])</span>
<span class="n">teams</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">teams</span><span class="o">.</span><span class="n">index</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">teams</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;home_team&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="s1">&#39;i_home&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">teams</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;away_team&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="s1">&#39;i_away&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">observed_home_goals</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">home_score</span><span class="o">.</span><span class="n">values</span>
<span class="n">observed_away_goals</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">away_score</span><span class="o">.</span><span class="n">values</span>

<span class="n">home_team</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">i_home</span><span class="o">.</span><span class="n">values</span>
<span class="n">away_team</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">i_away</span><span class="o">.</span><span class="n">values</span>

<span class="n">num_teams</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">i_home</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">())</span>
<span class="n">num_games</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">home_team</span><span class="p">)</span>

<span class="n">g</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;i_away&#39;</span><span class="p">)</span>
<span class="n">att_starting_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">away_score</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;i_home&#39;</span><span class="p">)</span>
<span class="n">def_starting_points</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">away_score</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</pre></div>
</div>
</div>
<ul class="simple">
<li>We did some munging above and adjustments of the data to make it
<strong>tidier</strong> for our model.</li>
<li>The log function to away scores and home scores is a standard trick
in the sports analytics literature</li>
</ul>
</div>
<div class="section" id="Building-of-the-model">
<h2>Building of the model<a class="headerlink" href="#Building-of-the-model" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>We now build the model in PyMC3, specifying the global parameters,
and the team-specific parameters and the likelihood function</li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">model</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span>
<span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model</span><span class="p">:</span>
    <span class="c1"># global model parameters</span>
    <span class="n">home</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Flat</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>
    <span class="n">sd_att</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfStudentT</span><span class="p">(</span><span class="s1">&#39;sd_att&#39;</span><span class="p">,</span> <span class="n">nu</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>
    <span class="n">sd_def</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfStudentT</span><span class="p">(</span><span class="s1">&#39;sd_def&#39;</span><span class="p">,</span> <span class="n">nu</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>
    <span class="n">intercept</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Flat</span><span class="p">(</span><span class="s1">&#39;intercept&#39;</span><span class="p">)</span>

    <span class="c1"># team-specific model parameters</span>
    <span class="n">atts_star</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;atts_star&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="n">sd_att</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">num_teams</span><span class="p">)</span>
    <span class="n">defs_star</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;defs_star&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="n">sd_def</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">num_teams</span><span class="p">)</span>

    <span class="n">atts</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s1">&#39;atts&#39;</span><span class="p">,</span> <span class="n">atts_star</span> <span class="o">-</span> <span class="n">tt</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">atts_star</span><span class="p">))</span>
    <span class="n">defs</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s1">&#39;defs&#39;</span><span class="p">,</span> <span class="n">defs_star</span> <span class="o">-</span> <span class="n">tt</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">defs_star</span><span class="p">))</span>
    <span class="n">home_theta</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">intercept</span> <span class="o">+</span> <span class="n">home</span> <span class="o">+</span> <span class="n">atts</span><span class="p">[</span><span class="n">home_team</span><span class="p">]</span> <span class="o">+</span> <span class="n">defs</span><span class="p">[</span><span class="n">away_team</span><span class="p">])</span>
    <span class="n">away_theta</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">intercept</span> <span class="o">+</span> <span class="n">atts</span><span class="p">[</span><span class="n">away_team</span><span class="p">]</span> <span class="o">+</span> <span class="n">defs</span><span class="p">[</span><span class="n">home_team</span><span class="p">])</span>

    <span class="c1"># likelihood of observed data</span>
    <span class="n">home_points</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Poisson</span><span class="p">(</span><span class="s1">&#39;home_points&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">home_theta</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">observed_home_goals</span><span class="p">)</span>
    <span class="n">away_points</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Poisson</span><span class="p">(</span><span class="s1">&#39;away_points&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">away_theta</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">observed_away_goals</span><span class="p">)</span>
</pre></div>
</div>
</div>
<ul class="simple">
<li>We specified the model and the likelihood function</li>
<li>All this runs on a Theano graph under the hood</li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="k">with</span> <span class="n">model</span><span class="p">:</span>
    <span class="n">trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
    <span class="n">pm</span><span class="o">.</span><span class="n">traceplot</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="stderr output_area docutils container">
<div class="highlight"><pre>
Auto-assigning NUTS sampler...
Initializing NUTS using ADVI...
Average Loss = 142.97:   9%|▉         | 18321/200000 [00:02&lt;00:28, 6460.70it/s]
Convergence archived at 18500
Interrupted at 18,500 [9%]: Average Loss = 375.49
100%|██████████| 2000/2000 [00:06&lt;00:00, 314.32it/s]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_rugby_analytics_15_1.png" src="../_images/notebooks_rugby_analytics_15_1.png" />
</div>
</div>
</div>
<div class="section" id="Results">
<h2>Results<a class="headerlink" href="#Results" title="Permalink to this headline">¶</a></h2>
<p>From the above we can start to understand the different distributions of
attacking strength and defensive strength. These are probabilistic
estimates and help us better understand the uncertainty in sports
analytics</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;France&#39;</span><span class="p">,</span> <span class="s1">&#39;Ireland&#39;</span><span class="p">,</span> <span class="s1">&#39;Scotland&#39;</span><span class="p">,</span> <span class="s1">&#39;Italy&#39;</span><span class="p">,</span> <span class="s1">&#39;England&#39;</span><span class="p">,</span> <span class="s1">&#39;Wales&#39;</span><span class="p">]</span>
<span class="n">pm</span><span class="o">.</span><span class="n">forestplot</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">varnames</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;atts&#39;</span><span class="p">],</span> <span class="n">ylabels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s2">&quot;Team Offense&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[7]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>&lt;matplotlib.gridspec.GridSpec at 0x1294bb940&gt;
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_rugby_analytics_17_1.png" src="../_images/notebooks_rugby_analytics_17_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">pm</span><span class="o">.</span><span class="n">forestplot</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">varnames</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;defs&#39;</span><span class="p">],</span> <span class="n">ylabels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s2">&quot;Team Defense&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[8]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>&lt;matplotlib.gridspec.GridSpec at 0x124057ef0&gt;
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_rugby_analytics_18_1.png" src="../_images/notebooks_rugby_analytics_18_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">pm</span><span class="o">.</span><span class="n">plot_posterior</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">varnames</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;defs&#39;</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_rugby_analytics_19_0.png" src="../_images/notebooks_rugby_analytics_19_0.png" />
</div>
</div>
</div>
<div class="section" id="Covariates">
<h2>Covariates<a class="headerlink" href="#Covariates" title="Permalink to this headline">¶</a></h2>
<p>We should do some exploration of the variables.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">df_trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">trace_to_dataframe</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="kn">as</span> <span class="nn">sns</span>

<span class="n">cols</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;atts_star__0&#39;</span><span class="p">:</span> <span class="s1">&#39;atts_star_france&#39;</span><span class="p">,</span>
    <span class="s1">&#39;atts_star__1&#39;</span><span class="p">:</span> <span class="s1">&#39;atts_star_ireland&#39;</span><span class="p">,</span>
    <span class="s1">&#39;atts_star__2&#39;</span><span class="p">:</span> <span class="s1">&#39;atts_star_scotland&#39;</span><span class="p">,</span>
    <span class="s1">&#39;atts_star__3&#39;</span><span class="p">:</span> <span class="s1">&#39;atts_star_italy&#39;</span><span class="p">,</span>
    <span class="s1">&#39;atts_star__4&#39;</span><span class="p">:</span> <span class="s1">&#39;atts_star_england&#39;</span><span class="p">,</span>
    <span class="s1">&#39;atts_star__5&#39;</span><span class="p">:</span> <span class="s1">&#39;atts_star_wales&#39;</span>
<span class="p">}</span>

<span class="n">df_trace_att</span> <span class="o">=</span> <span class="n">df_trace</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">cols</span><span class="p">)]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">pairplot</span><span class="p">(</span><span class="n">df_trace_att</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_rugby_analytics_22_0.png" src="../_images/notebooks_rugby_analytics_22_0.png" />
</div>
</div>
<p>We observe that there isn’t a lot of correlation between these
covariates, other than the weaker teams like Italy have a more negative
distribution of these variables. Nevertheless this is a good method to
get some insight into how the variables are behaving.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/pymc3_logo.jpg" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../index.html">PyMC3</a></h1>



<p class="blurb">Probabilistic Programming in Python: Bayesian Modeling and Probabilistic Machine Learning with Theano</p>






<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../prob_dists.html">Probability Distributions</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../examples.html#howto">Howto</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../examples.html#applied">Applied</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="BEST.html">Bayesian Estimation Supersedes the T-Test</a></li>
<li class="toctree-l3"><a class="reference internal" href="multilevel_modeling.html">A Primer on Bayesian Methods for Multilevel Modeling</a></li>
<li class="toctree-l3"><a class="reference internal" href="stochastic_volatility.html">Stochastic Volatility model</a></li>
<li class="toctree-l3"><a class="reference internal" href="probabilistic_matrix_factorization.html">Probabilistic Matrix Factorization for Making Personalized Recommendations</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">A Hierarchical model for Rugby prediction</a></li>
<li class="toctree-l3"><a class="reference internal" href="survival_analysis.html">Bayesian Survival Analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="dawid-skene.html">The Dawid-Skene model with priors</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#glm">GLM</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#gaussian-processes">Gaussian Processes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#mixture-models">Mixture Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#variational-inference">Variational Inference</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, The PyMC Development Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="../_sources/notebooks/rugby_analytics.ipynb.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>